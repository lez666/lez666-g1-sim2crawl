# G1 Crawl 键盘控制说明（中文版）

## 概述

`run_sim2sim_keyboard.py` 是一个支持键盘控制的 MuJoCo 仿真部署脚本。机器人初始为站立状态（policy 模式），可以通过键盘进行实时控制。

### 演示动图

![机器人爬行演示](docs/images/robot_crawling_demo.gif)

*注：上图展示了机器人在仿真环境中使用键盘控制进行爬行运动的动画演示*

---

## 🎯 本版本增强功能

本版本在原项目基础上新增了完整的**键盘控制功能**，无需游戏手柄即可使用键盘控制机器人。

### 主要贡献

1. **完整的键盘控制实现**
   - 实现了基于 `pynput` 库的跨平台键盘输入处理
   - 支持所有原项目游戏手柄的功能，包括运动控制、模式切换、策略切换等

2. **键盘映射设计**
   - **方向键**：直观的前后左右移动控制
   - **IJK 键**：对应原项目 D-PAD 的模式切换功能
   - **Z/C 键**：旋转控制
   - **SPACE 键**：策略循环切换
   - **Q/A/H 键**：实时增益调整

3. **与原项目功能对齐**
   - 完全保留原项目的所有控制逻辑和安全特性
   - 支持所有控制模式（default_pos, crawl_pos, damped, policy）
   - 保留增益调整功能，支持实时修改 PD 增益
   - 保留完整的安全监控系统

4. **用户体验优化**
   - 机器人初始为站立状态，无需额外操作即可开始控制
   - 清晰的键盘控制说明
   - 详细的中英文文档

### 技术实现

- 使用 `pynput` 库实现跨平台键盘监听（Linux 无需 root 权限）
- 完整的按键状态管理和边缘检测
- 模式切换和策略切换的状态同步
- 与原代码架构无缝集成

---

## 功能对比：键盘 vs 手柄

本版本在保留原项目所有功能的基础上，提供了键盘控制作为游戏手柄的替代方案。

| 功能 | 手柄控制 (run_sim2sim.py) | 键盘控制 (run_sim2sim_keyboard.py) |
|------|---------------------------|-----------------------------------|
| **运动控制** | 左摇杆 Y/X，右摇杆 X | 方向键 ↑↓←→，Z/C 旋转 |
| **模式切换** | D-PAD 方向键 | IJK 键（I=站立，J=阻尼，K=爬行） |
| **策略切换** | A 按钮循环切换 | SPACE 键循环切换 |
| **增益调整** | 键盘 Q/A/H | 键盘 Q/A/H（相同） |
| **系统启动** | 需要按 START | 初始已启用（policy 模式） |
| **退出程序** | SELECT 按钮 | ESC 键 |
| **跨平台支持** | 需要 GLFW 和游戏手柄 | 使用 pynput（Linux 无需 root） |
| **依赖要求** | glfw + 游戏手柄 | pynput（更轻量） |
| **使用场景** | 有游戏手柄的用户 | 没有游戏手柄的用户 |

> **注意**: 键盘控制和手柄控制功能完全对等，所有控制逻辑和安全特性都保持一致。

---

## 安装依赖

```bash
conda activate g1-crawl
pip install -r requirements.txt
```

## 运行程序

```bash
cd sim2sim_mj
conda activate g1-crawl
python run_sim2sim_keyboard.py
```

## 键盘控制

### 快速参考表

| 按键 | 功能 | 生效模式 | 说明 |
|------|------|---------|------|
| **↑** | 前进 | policy | 方向键上 |
| **↓** | 后退 | policy | 方向键下 |
| **←** | 左平移 | policy | 方向键左 |
| **→** | 右平移 | policy | 方向键右 |
| **Z** | 左转（逆时针） | policy | 旋转控制 |
| **C** | 右转（顺时针） | policy | 旋转控制 |
| **I** | 默认位置模式（站立） | 全部 | 对应原项目 D-PAD UP |
| **J** | 阻尼模式（安全停止） | 全部 | 对应原项目 D-PAD LEFT |
| **K** | 爬行位置模式 | 全部 | 对应原项目 D-PAD DOWN |
| **SPACE** | 循环切换策略 | policy | 对应原项目 A 按钮 |
| **Q** | 增加增益 | 全部 | 步进 +0.1 |
| **A** | 减少增益 | 全部 | 步进 -0.1 |
| **H** | 显示当前增益 | 全部 | 打印到终端 |
| **ESC** | 退出程序 | 全部 | 立即退出 |

> **注意**: 机器人初始状态为 **policy 模式**（站立控制），无需按任何键即可开始控制。

### 详细说明

#### 运动控制（方向键 + Z/C）

在 policy 模式下，使用方向键控制机器人运动：

- **↑ (上方向键)**: 前进
- **↓ (下方向键)**: 后退
- **← (左方向键)**: 左平移
- **→ (右方向键)**: 右平移
- **Z**: 左转（逆时针旋转）
- **C**: 右转（顺时针旋转）

> **注意**: 运动控制仅在 policy 模式下有效。

#### 模式切换（IJK 键）

使用 IJK 键切换不同的控制模式（对应原项目的 D-PAD 功能）：

- **I**: 默认位置模式（Default Position Mode）
  - 机器人切换到站立姿态
  - 平滑过渡到预设的站立关节角度

- **J**: 阻尼模式（Damped Mode）
  - 安全停止模式
  - 所有关节进入高阻尼状态，停止运动
  - 立即切换，无过渡时间

- **K**: 爬行位置模式（Crawl Position Mode）
  - 机器人切换到爬行姿态
  - 平滑过渡到预设的爬行关节角度

#### 策略控制

- **SPACE (空格键)**: 循环切换已加载的策略
  - 仅在 policy 模式下有效
  - 按下空格键会在策略列表中循环切换
  - 默认策略顺序：
    1. `policy_shamble.pt` (站立/行走策略)
    2. `policy_crawl_start.pt` (爬行启动策略)
    3. `policy_crawl.pt` (爬行策略)

#### 增益调整

增益调整在任何模式下都可用：

- **Q**: 增加增益倍数（步进 0.1）
- **A**: 减少增益倍数（步进 0.1）
- **H**: 打印当前增益倍数

增益倍数影响所有关节的 PD 增益（KP 和 KD），影响机器人运动的刚性和响应速度。

#### 退出程序

- **ESC**: 退出仿真程序

## 配置选项

在 `run_sim2sim_keyboard.py` 文件的 `CONFIG` 部分可以修改以下设置：

### 基本配置

- `model_xml`: MuJoCo 场景文件路径（默认: "scene.xml"）
- `policy_path`: 初始策略文件（默认: "policies/policy_shamble.pt"）
- `action_scale`: 全局动作缩放倍数（默认: 0.5）
- `n_substeps`: 每个策略步的仿真子步数（默认: 4）

### 速度限制

- `max_lin_vel`: 最大前进/后退速度（m/s，默认: 2.0）
- `max_lat_vel`: 最大左右平移速度（m/s，默认: 1.0）
- `max_ang_vel`: 最大旋转速度（rad/s，默认: 1.0）

### 策略配置

- `policy_cycle`: 策略循环列表
- `policy_defaults`: 策略到默认关节集的映射（"stand" 或 "crawl"）
- `gain_step`: 增益调整步进大小（默认: 0.1）

### 相机配置

- `camera_distance`: 相机距离（米，默认: 3.0）
- `camera_azimuth`: 相机方位角（度，默认: 90）
- `camera_elevation`: 相机仰角（度，默认: -20）
- `camera_tracking`: 是否跟踪机器人位置（默认: True）

## 使用示例

### 基本操作流程

1. **启动程序**
   ```bash
   python run_sim2sim_keyboard.py
   ```
   - 程序启动后，机器人初始为站立状态（policy 模式）
   - MuJoCo viewer 窗口会自动打开

2. **控制机器人运动**
   - 使用方向键控制前进/后退和左右平移
   - 使用 Z/C 控制旋转
   - 速度限制由当前策略配置决定

3. **切换策略**
   - 按下 SPACE 键循环切换策略
   - 每个策略有不同的速度限制和默认姿态

4. **切换模式**
   - 按下 I 切换到站立姿态
   - 按下 K 切换到爬行姿态
   - 按下 J 进入安全停止模式

5. **调整增益**
   - 按下 Q 增加增益（更刚性）
   - 按下 A 减少增益（更柔顺）
   - 按下 H 查看当前增益值

6. **退出程序**
   - 按下 ESC 键退出

### 从站立到爬行的完整流程

1. 启动程序（机器人初始为站立状态）
2. 使用方向键和 Z/C 控制机器人移动（站立模式）
3. 按下 SPACE 切换到 `policy_crawl_start.pt`
4. 按下 K 切换到爬行位置模式
5. 等待过渡完成（数秒）
6. 按下 SPACE 切换到 `policy_crawl.pt`
7. 使用方向键控制爬行运动

## 安全特性

程序包含安全监控功能，会检测以下异常情况并打印警告：

- **位置跳跃检测**: 检测关节位置是否发生异常跳跃（阈值: 15.0 rad/s）
- **速度尖峰检测**: 检测关节速度是否超过限制（阈值: 25.0 rad/s）
- **加速度尖峰检测**: 检测关节加速度是否超过限制（阈值: 1500 rad/s²）

> **注意**: 在仿真中，这些警告不会停止程序，只是提示。如果这是真实机器人，这些违规可能会触发安全保护。

## 故障排除

### 机器人不响应控制

- 确保 MuJoCo viewer 窗口处于焦点状态
- 检查是否在 policy 模式下（初始状态就是 policy 模式）
- 确认已加载策略文件

### 窗口无法拖动

- 确保未启用 `suppress=True`（已默认关闭）
- 尝试点击窗口标题栏后再拖动

### 按键冲突

- MuJoCo viewer 的快捷键（如 SPACE 播放/暂停）可能会与程序控制冲突
- 建议在使用控制时，将焦点保持在 viewer 窗口上

## 技术规格

- **控制频率**: 50 Hz（20 ms 周期）
- **策略更新频率**: 每 4 个仿真步更新一次（可配置 `n_substeps`）
- **关节数量**: 23 个
- **策略输入维度**: 75（重力投影 3 + 速度命令 3 + 关节位置 23 + 关节速度 23 + 上次动作 23）
- **策略输出维度**: 23（关节目标位置）

## 文件结构

```
sim2sim_mj/
├── run_sim2sim_keyboard.py  # 主程序（键盘控制版本）
├── run_sim2sim.py            # 原版程序（手柄控制）
├── scene.xml                 # MuJoCo 场景文件
├── policies/                 # 策略文件目录
│   ├── policy_shamble.pt
│   ├── policy_crawl_start.pt
│   └── policy_crawl.pt
├── poses/                    # 初始姿态配置
│   ├── default-pose.json
│   └── crawl-pose.json
└── requirements.txt          # 依赖包列表
```

## 演示素材

演示截图和视频位于 `docs/` 目录：

```
sim2sim_mj/
└── docs/
    ├── images/
    │   └── robot_crawling_demo.gif  # 机器人爬行演示动图
    └── videos/
        └── keyboard_control_demo.mp4  # 键盘控制演示视频（可选）
```

## 许可证

请参考项目根目录的 LICENSE 文件。

## 致谢

本键盘控制功能基于原项目的游戏手柄控制实现，在保留所有原有功能的基础上，为没有游戏手柄的用户提供了键盘控制方案。

---

*最后更新: 2026.1*
